<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.49">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Spring Security 5 | 桉树</title><meta name="description" content="考拉的粮食">
    <link rel="modulepreload" href="/assets/app.00e82ae7.js"><link rel="modulepreload" href="/assets/index.html.b384268d.js"><link rel="modulepreload" href="/assets/index.html.3c145cd8.js"><link rel="prefetch" href="/assets/index.html.d8d8e853.js"><link rel="prefetch" href="/assets/index.html.dfaf787b.js"><link rel="prefetch" href="/assets/index.html.7f09570d.js"><link rel="prefetch" href="/assets/singleton.html.1f99f4b0.js"><link rel="prefetch" href="/assets/byte.html.9e0965c8.js"><link rel="prefetch" href="/assets/calculate.html.6adca823.js"><link rel="prefetch" href="/assets/collection.html.8791ed9c.js"><link rel="prefetch" href="/assets/enum.html.2bf74a6e.js"><link rel="prefetch" href="/assets/map.html.b875c291.js"><link rel="prefetch" href="/assets/string.html.f7ba752a.js"><link rel="prefetch" href="/assets/index.html.858487a1.js"><link rel="prefetch" href="/assets/index.html.c47a9954.js"><link rel="prefetch" href="/assets/index.html.a3d742ea.js"><link rel="prefetch" href="/assets/index.html.237e47d5.js"><link rel="prefetch" href="/assets/index.html.0e354957.js"><link rel="prefetch" href="/assets/index.html.7d1cda21.js"><link rel="prefetch" href="/assets/index.html.c2e34699.js"><link rel="prefetch" href="/assets/README_OLD.html.b03dae1c.js"><link rel="prefetch" href="/assets/ant.html.3ba43451.js"><link rel="prefetch" href="/assets/controller.html.4b351758.js"><link rel="prefetch" href="/assets/index.html.9663bcb5.js"><link rel="prefetch" href="/assets/404.html.265028f6.js"><link rel="prefetch" href="/assets/index.html.356c8cc0.js"><link rel="prefetch" href="/assets/index.html.d148dd47.js"><link rel="prefetch" href="/assets/index.html.b082734f.js"><link rel="prefetch" href="/assets/singleton.html.318c26ed.js"><link rel="prefetch" href="/assets/byte.html.2bcd1ea3.js"><link rel="prefetch" href="/assets/calculate.html.8bdaadda.js"><link rel="prefetch" href="/assets/collection.html.3511e08e.js"><link rel="prefetch" href="/assets/enum.html.96984402.js"><link rel="prefetch" href="/assets/map.html.395980ea.js"><link rel="prefetch" href="/assets/string.html.8a840237.js"><link rel="prefetch" href="/assets/index.html.5a75afe3.js"><link rel="prefetch" href="/assets/index.html.f13d7e17.js"><link rel="prefetch" href="/assets/index.html.a724f9ff.js"><link rel="prefetch" href="/assets/index.html.00ed60ac.js"><link rel="prefetch" href="/assets/index.html.075e22e7.js"><link rel="prefetch" href="/assets/index.html.74355523.js"><link rel="prefetch" href="/assets/index.html.959c8cce.js"><link rel="prefetch" href="/assets/README_OLD.html.0eb1b87f.js"><link rel="prefetch" href="/assets/ant.html.2b5fbdc3.js"><link rel="prefetch" href="/assets/controller.html.5c009f8b.js"><link rel="prefetch" href="/assets/index.html.4a05b6b7.js"><link rel="prefetch" href="/assets/404.html.bf2fe065.js"><link rel="prefetch" href="/assets/404.5ca82847.js"><link rel="prefetch" href="/assets/Layout.8e240054.js">
    <link rel="stylesheet" href="/assets/style.96ee71b5.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt="桉树"><span class="site-name can-hide">桉树</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/java/basic/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/spring/ioc/" class="" aria-label="Spring"><!--[--><!--]--> Spring <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="系统设计"><span class="title">系统设计</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="系统设计"><span class="title">系统设计</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>认证授权</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a aria-current="page" href="/security/spring-security/" class="router-link-active router-link-exact-active router-link-active" aria-label="Spring Security 5"><!--[--><!--]--> Spring Security 5 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>消息队列</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/message-queue/basic/" class="" aria-label="基础知识"><!--[--><!--]--> 基础知识 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/message-queue/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/message-queue/rocket-mq/" class="" aria-label="RocketMQ"><!--[--><!--]--> RocketMQ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/message-queue/rabbit-mq/" class="" aria-label="RabbitMQ"><!--[--><!--]--> RabbitMQ <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/author/" class="" aria-label="关于作者"><!--[--><!--]--> 关于作者 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/java/basic/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/spring/ioc/" class="" aria-label="Spring"><!--[--><!--]--> Spring <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="系统设计"><span class="title">系统设计</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="系统设计"><span class="title">系统设计</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>认证授权</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a aria-current="page" href="/security/spring-security/" class="router-link-active router-link-exact-active router-link-active" aria-label="Spring Security 5"><!--[--><!--]--> Spring Security 5 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>消息队列</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/message-queue/basic/" class="" aria-label="基础知识"><!--[--><!--]--> 基础知识 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/message-queue/kafka/" class="" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/message-queue/rocket-mq/" class="" aria-label="RocketMQ"><!--[--><!--]--> RocketMQ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/message-queue/rabbit-mq/" class="" aria-label="RabbitMQ"><!--[--><!--]--> RabbitMQ <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/author/" class="" aria-label="关于作者"><!--[--><!--]--> 关于作者 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a aria-current="page" href="/security/spring-security/" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="Spring Security 5"><!--[--><!--]--> Spring Security 5 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/security/spring-security/#需求" class="router-link-active router-link-exact-active sidebar-item" aria-label="需求"><!--[--><!--]--> 需求 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#开源授权服务项目" class="router-link-active router-link-exact-active sidebar-item" aria-label="开源授权服务项目"><!--[--><!--]--> 开源授权服务项目 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#创建数据库" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建数据库"><!--[--><!--]--> 创建数据库 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#密码模式登录" class="router-link-active router-link-exact-active sidebar-item" aria-label="密码模式登录"><!--[--><!--]--> 密码模式登录 <!--[--><!--]--></a><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/security/spring-security/#认证请求" class="router-link-active router-link-exact-active sidebar-item" aria-label="认证请求"><!--[--><!--]--> 认证请求 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#关键类编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="关键类编码"><!--[--><!--]--> 关键类编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#认证服务配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="认证服务配置"><!--[--><!--]--> 认证服务配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#安全配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="安全配置"><!--[--><!--]--> 安全配置 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/security/spring-security/#踩坑" class="router-link-active router-link-exact-active sidebar-item" aria-label="踩坑"><!--[--><!--]--> 踩坑 <!--[--><!--]--></a><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/security/spring-security/#认证授权信息id" class="router-link-active router-link-exact-active sidebar-item" aria-label="认证授权信息ID"><!--[--><!--]--> 认证授权信息ID <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/security/spring-security/#认证授权信息保存" class="router-link-active router-link-exact-active sidebar-item" aria-label="认证授权信息保存"><!--[--><!--]--> 认证授权信息保存 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/security/spring-security/#拓展思考" class="router-link-active router-link-exact-active sidebar-item" aria-label="拓展思考"><!--[--><!--]--> 拓展思考 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="spring-security-5" tabindex="-1"><a class="header-anchor" href="#spring-security-5" aria-hidden="true">#</a> Spring Security 5</h1><p>谈到认证授权, 自然离不开OAuth</p><p>OAuth是互联网标准协议, 目前最新版本为2.1</p><p>在Spring体系下, 一般采用Spring Security + OAuth2的解决方案</p><p>但在百度搜索Spring Security OAuth2时</p><p>其结果中大部分使用的仍是<a href="https://github.com/spring-attic/spring-security-oauth" target="_blank" rel="noopener noreferrer">spring-security-oauth<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>打开其Github首页, 可以发现此项目已被设置为只读且说明了不再主动维护:</p><p><img src="/assets/spring-security-oauth.2703f819.png" alt="spring-security-oauth"></p><p>Spring Security 5.7.1于前段时间发布, 都2022年了, 让孩子升升级吧</p><h2 id="需求" tabindex="-1"><a class="header-anchor" href="#需求" aria-hidden="true">#</a> 需求</h2><p>暂且抛开技术栈思考, 实现一个基础的认证授权服务, 需要包含什么内容呢?</p><p>根据笔者的经验, 大致如下:</p><ul><li>权限模型: RBAC</li><li>授权类型: 支持密码模式登录</li><li>认证信息: <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT(<strong>J</strong>SON <strong>W</strong>eb <strong>T</strong>okens)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, 也就是我们常说的token</li><li>持久化: 数据库</li></ul><p>有了具体的目标, 只需要寻找合适的实现方案即可, 我们可以按照如下流程进行:</p><ol><li>选择开源授权服务项目</li><li>创建数据库</li><li>实现密码模式登录和JWT</li><li>持久化认证授权信息</li></ol><h2 id="开源授权服务项目" tabindex="-1"><a class="header-anchor" href="#开源授权服务项目" aria-hidden="true">#</a> 开源授权服务项目</h2><p>开头提到了<code>spring-security-oauth</code>已属于半废弃状态</p><p>但它的替代品Spring Authorization Server刚刚发布了0.3.0版本, 且官网上线了对应的<a href="https://docs.spring.io/spring-authorization-server/docs/current/reference/html/" target="_blank" rel="noopener noreferrer">文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>本文将会选择它作为OAuth2授权服务的基础</p><p>但Spring Authorization Server是基于<strong>OAuth2.1协议</strong>的, 其中<strong>删除了对密码模式的支持</strong></p><p>需要我们手动进行实现</p><h2 id="创建数据库" tabindex="-1"><a class="header-anchor" href="#创建数据库" aria-hidden="true">#</a> 创建数据库</h2><p>在数据库中我们需要创建如下两种内容的表:</p><ul><li>Spring Authorization Server持久化表</li><li>RBAC模型表</li></ul><p>Spring Authorization Server持久化表可参照文件: <a href="spring-authorization-server-schema.sql" download>spring-authorization-server-schema.sql</a></p><p>RBAC模型是老生常谈, 不再赘述, 大致包含如下表: t_user/t_role/t_permission/t_api/t_user_role/t_role_permission/t_permission_api</p><h2 id="密码模式登录" tabindex="-1"><a class="header-anchor" href="#密码模式登录" aria-hidden="true">#</a> 密码模式登录</h2><div class="custom-container tip"><p class="custom-container-title">提示</p><p>此内容为整个认证授权服务的核心, 请耐心阅读</p></div><h3 id="认证请求" tabindex="-1"><a class="header-anchor" href="#认证请求" aria-hidden="true">#</a> 认证请求</h3><p>在Spring Security中, 可以将认证请求拆分为如下内容:</p><p><img src="/assets/认证请求流程.ca6dcd71.jpg" alt="认证授权流程"></p><p>结合文档并阅读源码, 以客户端凭证模式为例, 可以得出在整个认证请求过程中的关键类:</p><ul><li><code>Authentication</code>: 认证信息, 贯穿整个认证请求流程, 包含多种, 如<code>OAuth2ClientCredentialsAuthenticationToken</code>/<code>OAuth2AccessTokenAuthenticationToken</code></li><li><code>AuthenticationConverter</code>: 认证请求转换器, 将请求转换为<code>Authentication</code>, 如<code>OAuth2ClientCredentialsAuthenticationConverter</code></li><li><code>AuthenticationProvider</code>: 认证信息提供者, 提供最终的认证授权信息, 如<code>OAuth2ClientCredentialsAuthenticationProvider</code></li></ul><p><em>在客户端凭证模式的认证请求中, 上图第三步<code>Authentication</code>为<code>OAuth2ClientCredentialsAuthenticationToken</code>, 第五步为<code>OAuth2AccessTokenAuthenticationToken</code></em></p><p>所以, 想要手动实现密码模式, 我们只需要完成三个关键类的编码:</p><ol><li><code>OAuth2ResourceOwnerPasswordAuthenticationConverter</code></li><li><code>OAuth2ResourceOwnerPasswordAuthenticationToken</code></li><li><code>OAuth2ResourceOwnerPasswordAuthenticationProvider</code></li></ol><h3 id="关键类编码" tabindex="-1"><a class="header-anchor" href="#关键类编码" aria-hidden="true">#</a> 关键类编码</h3><div class="custom-container warning"><p class="custom-container-title">警告</p><p>编码内容为简略版, 完整源码请参考项目<a href="https://github.com/Houtaroy/koala" target="_blank" rel="noopener noreferrer">Koala<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><p><code>OAuth2ResourceOwnerPasswordAuthenticationConverter</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationConverter</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationConverter</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNotSupport</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 参数校验</span>
    <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">requiredParameter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>CLIENT_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">requiredParameter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>CLIENT_SECRET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">(</span>
      <span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">,</span>
      <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">getClientPrincipalOrThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 用户名密码认证信息, 用于后续校验</span>
      <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
        <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">getParameterOrThrowException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>USERNAME<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">getParameterOrThrowException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isNotSupport</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>GRANT_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>OAuth2ResourceOwnerPasswordAuthenticationToken</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">OAuth2AuthorizationGrantAuthenticationToken</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> usernamePasswordAuthenticationToken<span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * 构造函数
   *
   * <span class="token keyword">@param</span> <span class="token parameter">authorizationGrantType</span>              授权类型
   * <span class="token keyword">@param</span> <span class="token parameter">clientPrincipal</span>                     客户端信息
   * <span class="token keyword">@param</span> <span class="token parameter">usernamePasswordAuthenticationToken</span> 用户密码认证Token
   * <span class="token keyword">@param</span> <span class="token parameter">additionalParameters</span>                附加参数
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">AuthorizationGrantType</span> authorizationGrantType<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">OAuth2ClientAuthenticationToken</span> clientPrincipal<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span>
                                                          usernamePasswordAuthenticationToken<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>authorizationGrantType<span class="token punctuation">,</span> clientPrincipal<span class="token punctuation">,</span> additionalParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>usernamePasswordAuthenticationToken <span class="token operator">=</span> usernamePasswordAuthenticationToken<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">RegisteredClient</span> <span class="token function">getRegisteredClientOrThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">::</span><span class="token function">cast</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientAuthenticationToken</span><span class="token operator">::</span><span class="token function">getRegisteredClient</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;注册客户端不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>OAuth2ResourceOwnerPasswordAuthenticationProvider</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">JwtEncoder</span> jwtEncoder<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">OAuth2AuthorizationService</span> oAuth2AuthorizationService<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ProviderProperties</span> providerProperties<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessTokenAuthenticationToken</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span> token <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">;</span>
    <span class="token class-name">RegisteredClient</span> registeredClient <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">getRegisteredClientOrThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用户名密码登录</span>
    <span class="token class-name">Authentication</span> userPrincipal <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取授权信息</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span>userPrincipal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token comment">// 生成JWT</span>
    <span class="token class-name">Instant</span> issuedAt <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> jwtEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
      <span class="token class-name">JwtEncoderParameters</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
        <span class="token class-name">JwsHeader</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>RS256<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">JwtClaimsSet</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">issuer</span><span class="token punctuation">(</span>providerProperties<span class="token punctuation">.</span><span class="token function">getIssuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">subject</span><span class="token punctuation">(</span>userPrincipal<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">issuedAt</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">expiresAt</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span>registeredClient<span class="token punctuation">.</span><span class="token function">getTokenSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessTokenTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">notBefore</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>SCOPE<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">OAuth2AccessToken</span> accessToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AccessToken</span><span class="token punctuation">(</span>
      <span class="token class-name">OAuth2AccessToken<span class="token punctuation">.</span>TokenType</span><span class="token punctuation">.</span>BEARER<span class="token punctuation">,</span>
      jwt<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      jwt<span class="token punctuation">.</span><span class="token function">getIssuedAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      jwt<span class="token punctuation">.</span><span class="token function">getExpiresAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      authorities
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 保存认证授权信息</span>
    oAuth2AuthorizationService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>
      <span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span><span class="token function">withRegisteredClient</span><span class="token punctuation">(</span>registeredClient<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">principalName</span><span class="token punctuation">(</span>userPrincipal<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">authorizationGrantType</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> metadata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization<span class="token punctuation">.</span>Token</span><span class="token punctuation">.</span>CLAIMS_METADATA_NAME<span class="token punctuation">,</span> jwt<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">attribute</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span>AUTHORIZED_SCOPE_ATTRIBUTE_NAME<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">attribute</span><span class="token punctuation">(</span><span class="token class-name">Principal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userPrincipal<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AccessTokenAuthenticationToken</span><span class="token punctuation">(</span>registeredClient<span class="token punctuation">,</span> userPrincipal<span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">GrantedAuthority</span><span class="token operator">::</span><span class="token function">getAuthority</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="认证服务配置" tabindex="-1"><a class="header-anchor" href="#认证服务配置" aria-hidden="true">#</a> 认证服务配置</h3><p>完成核心类编码后, 需要我们对安全过滤链进行手动配置:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">ProviderProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfig</span> <span class="token punctuation">{</span>
    
  <span class="token doc-comment comment">/**
   * 认证服务安全过滤链的bean
   *
   * <span class="token keyword">@param</span> <span class="token parameter">http</span>                       HttpSecurity
   * <span class="token keyword">@param</span> <span class="token parameter">oauth2AuthorizationService</span> 认证授权服务
   * <span class="token keyword">@param</span> <span class="token parameter">providerProperties</span>         提供者配置
   * <span class="token keyword">@return</span> 认证服务安全过滤链
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> 异常
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">,</span>
                                                 <span class="token class-name">OAuth2AuthorizationService</span> oauth2AuthorizationService<span class="token punctuation">,</span>
                                                 <span class="token class-name">ProviderProperties</span> providerProperties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> authorizationServerConfigurer <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 增加认证请求转换</span>
    <span class="token comment">// 这里不增加Provider是因为没有build前无法获得AuthenticationManager和JwtEncoder</span>
    authorizationServerConfigurer
      <span class="token punctuation">.</span><span class="token function">tokenEndpoint</span><span class="token punctuation">(</span>tokenEndpoint <span class="token operator">-&gt;</span>
        tokenEndpoint
          <span class="token punctuation">.</span><span class="token function">accessTokenRequestConverter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RequestMatcher</span> endpointsMatcher <span class="token operator">=</span> authorizationServerConfigurer<span class="token punctuation">.</span><span class="token function">getEndpointsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">requestMatcher</span><span class="token punctuation">(</span>endpointsMatcher<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>authorizeRequests <span class="token operator">-&gt;</span> authorizeRequests<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span>csrf <span class="token operator">-&gt;</span> csrf<span class="token punctuation">.</span><span class="token function">ignoringRequestMatchers</span><span class="token punctuation">(</span>endpointsMatcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>authorizationServerConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// build过滤链, 生成AuthenticationManager和JwtEncoder用于Provider</span>
    <span class="token class-name">SecurityFilterChain</span> result <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 增加认证信息提供者</span>
    http<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationProvider</span><span class="token punctuation">(</span>
      http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">JwtEncoder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      oauth2AuthorizationService<span class="token punctuation">,</span>
      providerProperties
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安全配置" tabindex="-1"><a class="header-anchor" href="#安全配置" aria-hidden="true">#</a> 安全配置</h3><p>认证服务配置完成后, 需要管理接口权限的资源服务, 需要完成对应的安全配置:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 开启接口权限校验</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token punctuation">{</span>
<span class="token doc-comment comment">/**
   * 授权服务器默认安全过滤器链配置
   *
   * <span class="token keyword">@param</span> <span class="token parameter">http</span> HttpSecurity对象
   * <span class="token keyword">@return</span> 安全过滤器链实例
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> 异常
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">SecurityFilterChain</span> <span class="token function">defaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">,</span> <span class="token class-name">JwtDecoder</span> jwtDecoder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认授权前缀为SCOPE_, 修改其为空</span>
    <span class="token class-name">JwtGrantedAuthoritiesConverter</span> grantedAuthoritiesConverter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtGrantedAuthoritiesConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    grantedAuthoritiesConverter<span class="token punctuation">.</span><span class="token function">setAuthorityPrefix</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JwtAuthenticationConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    converter<span class="token punctuation">.</span><span class="token function">setJwtGrantedAuthoritiesConverter</span><span class="token punctuation">(</span>grantedAuthoritiesConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span>oauth2 <span class="token operator">-&gt;</span>
        oauth2<span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span>jwt <span class="token operator">-&gt;</span> jwt<span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>jwtDecoder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jwtAuthenticationConverter</span><span class="token punctuation">(</span>converter<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此为止, 整个Spring Security + OAuth2的密码模式登录全部完成(<s>真的如此吗</s>)</p><h2 id="踩坑" tabindex="-1"><a class="header-anchor" href="#踩坑" aria-hidden="true">#</a> 踩坑</h2><h3 id="认证授权信息id" tabindex="-1"><a class="header-anchor" href="#认证授权信息id" aria-hidden="true">#</a> 认证授权信息ID</h3><p>需求章节中提到了, 我们需要将认证授权信息保存在数据库中</p><p>那么<strong>如何确定主键</strong>呢?</p><p>笔者采用<code>用户名 + 注册客户端ID + 授权类型 + 授权范围</code>的MD5值</p><p>保存认证授权信息使用的是<code>OAuth2AuthorizationService</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KoalaJdbcOAuth2AuthorizationService</span> <span class="token keyword">extends</span> <span class="token class-name">JdbcOAuth2AuthorizationService</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * 构造函数
   *
   * <span class="token keyword">@param</span> <span class="token parameter">jdbcOperations</span>             jdbc操作
   * <span class="token keyword">@param</span> <span class="token parameter">registeredClientRepository</span> 注册客户端存储库类
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">KoalaJdbcOAuth2AuthorizationService</span><span class="token punctuation">(</span><span class="token class-name">JdbcOperations</span> jdbcOperations<span class="token punctuation">,</span>
                                             <span class="token class-name">RegisteredClientRepository</span> registeredClientRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>jdbcOperations<span class="token punctuation">,</span> registeredClientRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span> authorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 覆盖原有方法, 重新计算id</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token function">generateAuthorizationId</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">generateAuthorizationId</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span> authorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>
        <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> authorization<span class="token punctuation">.</span><span class="token function">getPrincipalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>CLIENT_ID<span class="token punctuation">,</span> authorization<span class="token punctuation">.</span><span class="token function">getRegisteredClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>GRANT_TYPE<span class="token punctuation">,</span> authorization<span class="token punctuation">.</span><span class="token function">getAuthorizationGrantType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>SCOPE<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>
            authorization<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span>AUTHORIZED_SCOPE_ATTRIBUTE_NAME<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%032x&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;MD5 algorithm not available.  Fatal (should be in the JDK).&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="认证授权信息保存" tabindex="-1"><a class="header-anchor" href="#认证授权信息保存" aria-hidden="true">#</a> 认证授权信息保存</h3><p>认证授权信息会保存在数据库中, 其中包含了用户信息实体<code>UserEntity</code></p><p>第一次登录时, 会创建新的token并保存, 正常运行</p><p>第二次登陆时, 根据上一个坑中的唯一ID, 从数据库读取认证授权信息, <strong><code>UserEntity</code>将进行反序列化</strong>, 出现如下错误:</p><p><code>Could not read JSON: The class with cn.koala.system.entities.UserEntity and name of cn.koala.system.entities.UserEntity is not whitelisted. If you believe this class is safe to deserialize, please provide an explicit mapping using Jackson annotations or by providing a Mixin. If the serialization is only done by a trusted source, you can also enable default typing. See https://github.com/spring-projects/spring-security/issues/4370 for details</code></p><p>网上有很多修改方式, 笔者推荐使用<strong>注解<code>@JsonTypeInfo</code></strong>, 简单明了:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span>CLASS<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p>如果属性中有嵌套对象, <strong>嵌套对象也需要增加注解</strong></p></div><h2 id="拓展思考" tabindex="-1"><a class="header-anchor" href="#拓展思考" aria-hidden="true">#</a> 拓展思考</h2><ul><li>如何提供Swagger支持?</li><li>如何实现动态权限?</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">更新时间: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: Houtaroy@gmail.com">Houtaroy</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.00e82ae7.js" defer></script>
  </body>
</html>
