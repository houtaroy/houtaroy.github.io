import{_ as p,o,c,b as n,d as t,e as s,a as e,r as i}from"./app.00e82ae7.js";var u="/assets/spring-security-oauth.2703f819.png",l="/assets/\u8BA4\u8BC1\u8BF7\u6C42\u6D41\u7A0B.ca6dcd71.jpg";const r={},k=n("h1",{id:"spring-security-5",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#spring-security-5","aria-hidden":"true"},"#"),s(" Spring Security 5")],-1),d=n("p",null,"\u8C08\u5230\u8BA4\u8BC1\u6388\u6743, \u81EA\u7136\u79BB\u4E0D\u5F00OAuth",-1),v=n("p",null,"OAuth\u662F\u4E92\u8054\u7F51\u6807\u51C6\u534F\u8BAE, \u76EE\u524D\u6700\u65B0\u7248\u672C\u4E3A2.1",-1),m=n("p",null,"\u5728Spring\u4F53\u7CFB\u4E0B, \u4E00\u822C\u91C7\u7528Spring Security + OAuth2\u7684\u89E3\u51B3\u65B9\u6848",-1),h=n("p",null,"\u4F46\u5728\u767E\u5EA6\u641C\u7D22Spring Security OAuth2\u65F6",-1),b=s("\u5176\u7ED3\u679C\u4E2D\u5927\u90E8\u5206\u4F7F\u7528\u7684\u4ECD\u662F"),A={href:"https://github.com/spring-attic/spring-security-oauth",target:"_blank",rel:"noopener noreferrer"},g=s("spring-security-oauth"),w=n("p",null,"\u6253\u5F00\u5176Github\u9996\u9875, \u53EF\u4EE5\u53D1\u73B0\u6B64\u9879\u76EE\u5DF2\u88AB\u8BBE\u7F6E\u4E3A\u53EA\u8BFB\u4E14\u8BF4\u660E\u4E86\u4E0D\u518D\u4E3B\u52A8\u7EF4\u62A4:",-1),f=n("p",null,[n("img",{src:u,alt:"spring-security-oauth"})],-1),y=n("p",null,"Spring Security 5.7.1\u4E8E\u524D\u6BB5\u65F6\u95F4\u53D1\u5E03, \u90FD2022\u5E74\u4E86, \u8BA9\u5B69\u5B50\u5347\u5347\u7EA7\u5427",-1),_=n("h2",{id:"\u9700\u6C42",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u9700\u6C42","aria-hidden":"true"},"#"),s(" \u9700\u6C42")],-1),O=n("p",null,"\u6682\u4E14\u629B\u5F00\u6280\u672F\u6808\u601D\u8003, \u5B9E\u73B0\u4E00\u4E2A\u57FA\u7840\u7684\u8BA4\u8BC1\u6388\u6743\u670D\u52A1, \u9700\u8981\u5305\u542B\u4EC0\u4E48\u5185\u5BB9\u5462?",-1),S=n("p",null,"\u6839\u636E\u7B14\u8005\u7684\u7ECF\u9A8C, \u5927\u81F4\u5982\u4E0B:",-1),P=n("li",null,"\u6743\u9650\u6A21\u578B: RBAC",-1),T=n("li",null,"\u6388\u6743\u7C7B\u578B: \u652F\u6301\u5BC6\u7801\u6A21\u5F0F\u767B\u5F55",-1),C=s("\u8BA4\u8BC1\u4FE1\u606F: "),E={href:"https://jwt.io/",target:"_blank",rel:"noopener noreferrer"},R=s("JWT("),z=n("strong",null,"J",-1),x=s("SON "),j=n("strong",null,"W",-1),N=s("eb "),q=n("strong",null,"T",-1),I=s("okens)"),J=s(", \u4E5F\u5C31\u662F\u6211\u4EEC\u5E38\u8BF4\u7684token"),M=n("li",null,"\u6301\u4E45\u5316: \u6570\u636E\u5E93",-1),D=e('<p>\u6709\u4E86\u5177\u4F53\u7684\u76EE\u6807, \u53EA\u9700\u8981\u5BFB\u627E\u5408\u9002\u7684\u5B9E\u73B0\u65B9\u6848\u5373\u53EF, \u6211\u4EEC\u53EF\u4EE5\u6309\u7167\u5982\u4E0B\u6D41\u7A0B\u8FDB\u884C:</p><ol><li>\u9009\u62E9\u5F00\u6E90\u6388\u6743\u670D\u52A1\u9879\u76EE</li><li>\u521B\u5EFA\u6570\u636E\u5E93</li><li>\u5B9E\u73B0\u5BC6\u7801\u6A21\u5F0F\u767B\u5F55\u548CJWT</li><li>\u6301\u4E45\u5316\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F</li></ol><h2 id="\u5F00\u6E90\u6388\u6743\u670D\u52A1\u9879\u76EE" tabindex="-1"><a class="header-anchor" href="#\u5F00\u6E90\u6388\u6743\u670D\u52A1\u9879\u76EE" aria-hidden="true">#</a> \u5F00\u6E90\u6388\u6743\u670D\u52A1\u9879\u76EE</h2><p>\u5F00\u5934\u63D0\u5230\u4E86<code>spring-security-oauth</code>\u5DF2\u5C5E\u4E8E\u534A\u5E9F\u5F03\u72B6\u6001</p>',4),G=s("\u4F46\u5B83\u7684\u66FF\u4EE3\u54C1Spring Authorization Server\u521A\u521A\u53D1\u5E03\u4E860.3.0\u7248\u672C, \u4E14\u5B98\u7F51\u4E0A\u7EBF\u4E86\u5BF9\u5E94\u7684"),H={href:"https://docs.spring.io/spring-authorization-server/docs/current/reference/html/",target:"_blank",rel:"noopener noreferrer"},U=s("\u6587\u6863"),B=e('<p>\u672C\u6587\u5C06\u4F1A\u9009\u62E9\u5B83\u4F5C\u4E3AOAuth2\u6388\u6743\u670D\u52A1\u7684\u57FA\u7840</p><p>\u4F46Spring Authorization Server\u662F\u57FA\u4E8E<strong>OAuth2.1\u534F\u8BAE</strong>\u7684, \u5176\u4E2D<strong>\u5220\u9664\u4E86\u5BF9\u5BC6\u7801\u6A21\u5F0F\u7684\u652F\u6301</strong></p><p>\u9700\u8981\u6211\u4EEC\u624B\u52A8\u8FDB\u884C\u5B9E\u73B0</p><h2 id="\u521B\u5EFA\u6570\u636E\u5E93" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFA\u6570\u636E\u5E93" aria-hidden="true">#</a> \u521B\u5EFA\u6570\u636E\u5E93</h2><p>\u5728\u6570\u636E\u5E93\u4E2D\u6211\u4EEC\u9700\u8981\u521B\u5EFA\u5982\u4E0B\u4E24\u79CD\u5185\u5BB9\u7684\u8868:</p><ul><li>Spring Authorization Server\u6301\u4E45\u5316\u8868</li><li>RBAC\u6A21\u578B\u8868</li></ul><p>Spring Authorization Server\u6301\u4E45\u5316\u8868\u53EF\u53C2\u7167\u6587\u4EF6: <a href="spring-authorization-server-schema.sql" download>spring-authorization-server-schema.sql</a></p><p>RBAC\u6A21\u578B\u662F\u8001\u751F\u5E38\u8C08, \u4E0D\u518D\u8D58\u8FF0, \u5927\u81F4\u5305\u542B\u5982\u4E0B\u8868: t_user/t_role/t_permission/t_api/t_user_role/t_role_permission/t_permission_api</p><h2 id="\u5BC6\u7801\u6A21\u5F0F\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#\u5BC6\u7801\u6A21\u5F0F\u767B\u5F55" aria-hidden="true">#</a> \u5BC6\u7801\u6A21\u5F0F\u767B\u5F55</h2><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>\u6B64\u5185\u5BB9\u4E3A\u6574\u4E2A\u8BA4\u8BC1\u6388\u6743\u670D\u52A1\u7684\u6838\u5FC3, \u8BF7\u8010\u5FC3\u9605\u8BFB</p></div><h3 id="\u8BA4\u8BC1\u8BF7\u6C42" tabindex="-1"><a class="header-anchor" href="#\u8BA4\u8BC1\u8BF7\u6C42" aria-hidden="true">#</a> \u8BA4\u8BC1\u8BF7\u6C42</h3><p>\u5728Spring Security\u4E2D, \u53EF\u4EE5\u5C06\u8BA4\u8BC1\u8BF7\u6C42\u62C6\u5206\u4E3A\u5982\u4E0B\u5185\u5BB9:</p><p><img src="'+l+'" alt="\u8BA4\u8BC1\u6388\u6743\u6D41\u7A0B"></p><p>\u7ED3\u5408\u6587\u6863\u5E76\u9605\u8BFB\u6E90\u7801, \u4EE5\u5BA2\u6237\u7AEF\u51ED\u8BC1\u6A21\u5F0F\u4E3A\u4F8B, \u53EF\u4EE5\u5F97\u51FA\u5728\u6574\u4E2A\u8BA4\u8BC1\u8BF7\u6C42\u8FC7\u7A0B\u4E2D\u7684\u5173\u952E\u7C7B:</p><ul><li><code>Authentication</code>: \u8BA4\u8BC1\u4FE1\u606F, \u8D2F\u7A7F\u6574\u4E2A\u8BA4\u8BC1\u8BF7\u6C42\u6D41\u7A0B, \u5305\u542B\u591A\u79CD, \u5982<code>OAuth2ClientCredentialsAuthenticationToken</code>/<code>OAuth2AccessTokenAuthenticationToken</code></li><li><code>AuthenticationConverter</code>: \u8BA4\u8BC1\u8BF7\u6C42\u8F6C\u6362\u5668, \u5C06\u8BF7\u6C42\u8F6C\u6362\u4E3A<code>Authentication</code>, \u5982<code>OAuth2ClientCredentialsAuthenticationConverter</code></li><li><code>AuthenticationProvider</code>: \u8BA4\u8BC1\u4FE1\u606F\u63D0\u4F9B\u8005, \u63D0\u4F9B\u6700\u7EC8\u7684\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F, \u5982<code>OAuth2ClientCredentialsAuthenticationProvider</code></li></ul><p><em>\u5728\u5BA2\u6237\u7AEF\u51ED\u8BC1\u6A21\u5F0F\u7684\u8BA4\u8BC1\u8BF7\u6C42\u4E2D, \u4E0A\u56FE\u7B2C\u4E09\u6B65<code>Authentication</code>\u4E3A<code>OAuth2ClientCredentialsAuthenticationToken</code>, \u7B2C\u4E94\u6B65\u4E3A<code>OAuth2AccessTokenAuthenticationToken</code></em></p><p>\u6240\u4EE5, \u60F3\u8981\u624B\u52A8\u5B9E\u73B0\u5BC6\u7801\u6A21\u5F0F, \u6211\u4EEC\u53EA\u9700\u8981\u5B8C\u6210\u4E09\u4E2A\u5173\u952E\u7C7B\u7684\u7F16\u7801:</p><ol><li><code>OAuth2ResourceOwnerPasswordAuthenticationConverter</code></li><li><code>OAuth2ResourceOwnerPasswordAuthenticationToken</code></li><li><code>OAuth2ResourceOwnerPasswordAuthenticationProvider</code></li></ol><h3 id="\u5173\u952E\u7C7B\u7F16\u7801" tabindex="-1"><a class="header-anchor" href="#\u5173\u952E\u7C7B\u7F16\u7801" aria-hidden="true">#</a> \u5173\u952E\u7C7B\u7F16\u7801</h3>',19),W={class:"custom-container warning"},F=n("p",{class:"custom-container-title"},"\u8B66\u544A",-1),L=s("\u7F16\u7801\u5185\u5BB9\u4E3A\u7B80\u7565\u7248, \u5B8C\u6574\u6E90\u7801\u8BF7\u53C2\u8003\u9879\u76EE"),V={href:"https://github.com/Houtaroy/koala",target:"_blank",rel:"noopener noreferrer"},K=s("Koala"),Y=e(`<p><code>OAuth2ResourceOwnerPasswordAuthenticationConverter</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationConverter</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationConverter</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNotSupport</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u53C2\u6570\u6821\u9A8C</span>
    <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">requiredParameter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>CLIENT_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">requiredParameter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>CLIENT_SECRET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">(</span>
      <span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">,</span>
      <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">getClientPrincipalOrThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// \u7528\u6237\u540D\u5BC6\u7801\u8BA4\u8BC1\u4FE1\u606F, \u7528\u4E8E\u540E\u7EED\u6821\u9A8C</span>
      <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
        <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">getParameterOrThrowException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>USERNAME<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">OAuth2Helper</span><span class="token punctuation">.</span><span class="token function">getParameterOrThrowException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isNotSupport</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>GRANT_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>OAuth2ResourceOwnerPasswordAuthenticationToken</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">OAuth2AuthorizationGrantAuthenticationToken</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> usernamePasswordAuthenticationToken<span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * \u6784\u9020\u51FD\u6570
   *
   * <span class="token keyword">@param</span> <span class="token parameter">authorizationGrantType</span>              \u6388\u6743\u7C7B\u578B
   * <span class="token keyword">@param</span> <span class="token parameter">clientPrincipal</span>                     \u5BA2\u6237\u7AEF\u4FE1\u606F
   * <span class="token keyword">@param</span> <span class="token parameter">usernamePasswordAuthenticationToken</span> \u7528\u6237\u5BC6\u7801\u8BA4\u8BC1Token
   * <span class="token keyword">@param</span> <span class="token parameter">additionalParameters</span>                \u9644\u52A0\u53C2\u6570
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">AuthorizationGrantType</span> authorizationGrantType<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">OAuth2ClientAuthenticationToken</span> clientPrincipal<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span>
                                                          usernamePasswordAuthenticationToken<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>authorizationGrantType<span class="token punctuation">,</span> clientPrincipal<span class="token punctuation">,</span> additionalParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>usernamePasswordAuthenticationToken <span class="token operator">=</span> usernamePasswordAuthenticationToken<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">RegisteredClient</span> <span class="token function">getRegisteredClientOrThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">::</span><span class="token function">cast</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientAuthenticationToken</span><span class="token operator">::</span><span class="token function">getRegisteredClient</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;\u6CE8\u518C\u5BA2\u6237\u7AEF\u4E0D\u5B58\u5728&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>OAuth2ResourceOwnerPasswordAuthenticationProvider</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">JwtEncoder</span> jwtEncoder<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">OAuth2AuthorizationService</span> oAuth2AuthorizationService<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ProviderProperties</span> providerProperties<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessTokenAuthenticationToken</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span> token <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">;</span>
    <span class="token class-name">RegisteredClient</span> registeredClient <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">getRegisteredClientOrThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u7528\u6237\u540D\u5BC6\u7801\u767B\u5F55</span>
    <span class="token class-name">Authentication</span> userPrincipal <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u83B7\u53D6\u6388\u6743\u4FE1\u606F</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span>userPrincipal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token comment">// \u751F\u6210JWT</span>
    <span class="token class-name">Instant</span> issuedAt <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> jwtEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
      <span class="token class-name">JwtEncoderParameters</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
        <span class="token class-name">JwsHeader</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>RS256<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">JwtClaimsSet</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">issuer</span><span class="token punctuation">(</span>providerProperties<span class="token punctuation">.</span><span class="token function">getIssuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">subject</span><span class="token punctuation">(</span>userPrincipal<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">issuedAt</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">expiresAt</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span>registeredClient<span class="token punctuation">.</span><span class="token function">getTokenSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessTokenTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">notBefore</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>SCOPE<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">OAuth2AccessToken</span> accessToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AccessToken</span><span class="token punctuation">(</span>
      <span class="token class-name">OAuth2AccessToken<span class="token punctuation">.</span>TokenType</span><span class="token punctuation">.</span>BEARER<span class="token punctuation">,</span>
      jwt<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      jwt<span class="token punctuation">.</span><span class="token function">getIssuedAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      jwt<span class="token punctuation">.</span><span class="token function">getExpiresAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      authorities
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \u4FDD\u5B58\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F</span>
    oAuth2AuthorizationService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>
      <span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span><span class="token function">withRegisteredClient</span><span class="token punctuation">(</span>registeredClient<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">principalName</span><span class="token punctuation">(</span>userPrincipal<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">authorizationGrantType</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> metadata<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization<span class="token punctuation">.</span>Token</span><span class="token punctuation">.</span>CLAIMS_METADATA_NAME<span class="token punctuation">,</span> jwt<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">attribute</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span>AUTHORIZED_SCOPE_ATTRIBUTE_NAME<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">attribute</span><span class="token punctuation">(</span><span class="token class-name">Principal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userPrincipal<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2AccessTokenAuthenticationToken</span><span class="token punctuation">(</span>registeredClient<span class="token punctuation">,</span> userPrincipal<span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">GrantedAuthority</span><span class="token operator">::</span><span class="token function">getAuthority</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u8BA4\u8BC1\u670D\u52A1\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u8BA4\u8BC1\u670D\u52A1\u914D\u7F6E" aria-hidden="true">#</a> \u8BA4\u8BC1\u670D\u52A1\u914D\u7F6E</h3><p>\u5B8C\u6210\u6838\u5FC3\u7C7B\u7F16\u7801\u540E, \u9700\u8981\u6211\u4EEC\u5BF9\u5B89\u5168\u8FC7\u6EE4\u94FE\u8FDB\u884C\u624B\u52A8\u914D\u7F6E:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">ProviderProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfig</span> <span class="token punctuation">{</span>
    
  <span class="token doc-comment comment">/**
   * \u8BA4\u8BC1\u670D\u52A1\u5B89\u5168\u8FC7\u6EE4\u94FE\u7684bean
   *
   * <span class="token keyword">@param</span> <span class="token parameter">http</span>                       HttpSecurity
   * <span class="token keyword">@param</span> <span class="token parameter">oauth2AuthorizationService</span> \u8BA4\u8BC1\u6388\u6743\u670D\u52A1
   * <span class="token keyword">@param</span> <span class="token parameter">providerProperties</span>         \u63D0\u4F9B\u8005\u914D\u7F6E
   * <span class="token keyword">@return</span> \u8BA4\u8BC1\u670D\u52A1\u5B89\u5168\u8FC7\u6EE4\u94FE
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> \u5F02\u5E38
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">,</span>
                                                 <span class="token class-name">OAuth2AuthorizationService</span> oauth2AuthorizationService<span class="token punctuation">,</span>
                                                 <span class="token class-name">ProviderProperties</span> providerProperties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> authorizationServerConfigurer <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u589E\u52A0\u8BA4\u8BC1\u8BF7\u6C42\u8F6C\u6362</span>
    <span class="token comment">// \u8FD9\u91CC\u4E0D\u589E\u52A0Provider\u662F\u56E0\u4E3A\u6CA1\u6709build\u524D\u65E0\u6CD5\u83B7\u5F97AuthenticationManager\u548CJwtEncoder</span>
    authorizationServerConfigurer
      <span class="token punctuation">.</span><span class="token function">tokenEndpoint</span><span class="token punctuation">(</span>tokenEndpoint <span class="token operator">-&gt;</span>
        tokenEndpoint
          <span class="token punctuation">.</span><span class="token function">accessTokenRequestConverter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RequestMatcher</span> endpointsMatcher <span class="token operator">=</span> authorizationServerConfigurer<span class="token punctuation">.</span><span class="token function">getEndpointsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">requestMatcher</span><span class="token punctuation">(</span>endpointsMatcher<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>authorizeRequests <span class="token operator">-&gt;</span> authorizeRequests<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span>csrf <span class="token operator">-&gt;</span> csrf<span class="token punctuation">.</span><span class="token function">ignoringRequestMatchers</span><span class="token punctuation">(</span>endpointsMatcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>authorizationServerConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// build\u8FC7\u6EE4\u94FE, \u751F\u6210AuthenticationManager\u548CJwtEncoder\u7528\u4E8EProvider</span>
    <span class="token class-name">SecurityFilterChain</span> result <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u589E\u52A0\u8BA4\u8BC1\u4FE1\u606F\u63D0\u4F9B\u8005</span>
    http<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OAuth2ResourceOwnerPasswordAuthenticationProvider</span><span class="token punctuation">(</span>
      http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">JwtEncoder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      oauth2AuthorizationService<span class="token punctuation">,</span>
      providerProperties
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5B89\u5168\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u5B89\u5168\u914D\u7F6E" aria-hidden="true">#</a> \u5B89\u5168\u914D\u7F6E</h3><p>\u8BA4\u8BC1\u670D\u52A1\u914D\u7F6E\u5B8C\u6210\u540E, \u9700\u8981\u7BA1\u7406\u63A5\u53E3\u6743\u9650\u7684\u8D44\u6E90\u670D\u52A1, \u9700\u8981\u5B8C\u6210\u5BF9\u5E94\u7684\u5B89\u5168\u914D\u7F6E:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// \u5F00\u542F\u63A5\u53E3\u6743\u9650\u6821\u9A8C</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token punctuation">{</span>
<span class="token doc-comment comment">/**
   * \u6388\u6743\u670D\u52A1\u5668\u9ED8\u8BA4\u5B89\u5168\u8FC7\u6EE4\u5668\u94FE\u914D\u7F6E
   *
   * <span class="token keyword">@param</span> <span class="token parameter">http</span> HttpSecurity\u5BF9\u8C61
   * <span class="token keyword">@return</span> \u5B89\u5168\u8FC7\u6EE4\u5668\u94FE\u5B9E\u4F8B
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> \u5F02\u5E38
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">SecurityFilterChain</span> <span class="token function">defaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">,</span> <span class="token class-name">JwtDecoder</span> jwtDecoder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u9ED8\u8BA4\u6388\u6743\u524D\u7F00\u4E3ASCOPE_, \u4FEE\u6539\u5176\u4E3A\u7A7A</span>
    <span class="token class-name">JwtGrantedAuthoritiesConverter</span> grantedAuthoritiesConverter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtGrantedAuthoritiesConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    grantedAuthoritiesConverter<span class="token punctuation">.</span><span class="token function">setAuthorityPrefix</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JwtAuthenticationConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    converter<span class="token punctuation">.</span><span class="token function">setJwtGrantedAuthoritiesConverter</span><span class="token punctuation">(</span>grantedAuthoritiesConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span>oauth2 <span class="token operator">-&gt;</span>
        oauth2<span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span>jwt <span class="token operator">-&gt;</span> jwt<span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>jwtDecoder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jwtAuthenticationConverter</span><span class="token punctuation">(</span>converter<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u81F3\u6B64\u4E3A\u6B62, \u6574\u4E2ASpring Security + OAuth2\u7684\u5BC6\u7801\u6A21\u5F0F\u767B\u5F55\u5168\u90E8\u5B8C\u6210(<s>\u771F\u7684\u5982\u6B64\u5417</s>)</p><h2 id="\u8E29\u5751" tabindex="-1"><a class="header-anchor" href="#\u8E29\u5751" aria-hidden="true">#</a> \u8E29\u5751</h2><h3 id="\u8BA4\u8BC1\u6388\u6743\u4FE1\u606Fid" tabindex="-1"><a class="header-anchor" href="#\u8BA4\u8BC1\u6388\u6743\u4FE1\u606Fid" aria-hidden="true">#</a> \u8BA4\u8BC1\u6388\u6743\u4FE1\u606FID</h3><p>\u9700\u6C42\u7AE0\u8282\u4E2D\u63D0\u5230\u4E86, \u6211\u4EEC\u9700\u8981\u5C06\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F\u4FDD\u5B58\u5728\u6570\u636E\u5E93\u4E2D</p><p>\u90A3\u4E48<strong>\u5982\u4F55\u786E\u5B9A\u4E3B\u952E</strong>\u5462?</p><p>\u7B14\u8005\u91C7\u7528<code>\u7528\u6237\u540D + \u6CE8\u518C\u5BA2\u6237\u7AEFID + \u6388\u6743\u7C7B\u578B + \u6388\u6743\u8303\u56F4</code>\u7684MD5\u503C</p><p>\u4FDD\u5B58\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F\u4F7F\u7528\u7684\u662F<code>OAuth2AuthorizationService</code>:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KoalaJdbcOAuth2AuthorizationService</span> <span class="token keyword">extends</span> <span class="token class-name">JdbcOAuth2AuthorizationService</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * \u6784\u9020\u51FD\u6570
   *
   * <span class="token keyword">@param</span> <span class="token parameter">jdbcOperations</span>             jdbc\u64CD\u4F5C
   * <span class="token keyword">@param</span> <span class="token parameter">registeredClientRepository</span> \u6CE8\u518C\u5BA2\u6237\u7AEF\u5B58\u50A8\u5E93\u7C7B
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">KoalaJdbcOAuth2AuthorizationService</span><span class="token punctuation">(</span><span class="token class-name">JdbcOperations</span> jdbcOperations<span class="token punctuation">,</span>
                                             <span class="token class-name">RegisteredClientRepository</span> registeredClientRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>jdbcOperations<span class="token punctuation">,</span> registeredClientRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span> authorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8986\u76D6\u539F\u6709\u65B9\u6CD5, \u91CD\u65B0\u8BA1\u7B97id</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token function">generateAuthorizationId</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">generateAuthorizationId</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span> authorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>
        <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> authorization<span class="token punctuation">.</span><span class="token function">getPrincipalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>CLIENT_ID<span class="token punctuation">,</span> authorization<span class="token punctuation">.</span><span class="token function">getRegisteredClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>GRANT_TYPE<span class="token punctuation">,</span> authorization<span class="token punctuation">.</span><span class="token function">getAuthorizationGrantType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">OAuth2ParameterNames</span><span class="token punctuation">.</span>SCOPE<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>
            authorization<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authorization</span><span class="token punctuation">.</span>AUTHORIZED_SCOPE_ATTRIBUTE_NAME<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%032x&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;MD5 algorithm not available.  Fatal (should be in the JDK).&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F\u4FDD\u5B58" tabindex="-1"><a class="header-anchor" href="#\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F\u4FDD\u5B58" aria-hidden="true">#</a> \u8BA4\u8BC1\u6388\u6743\u4FE1\u606F\u4FDD\u5B58</h3><p>\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F\u4F1A\u4FDD\u5B58\u5728\u6570\u636E\u5E93\u4E2D, \u5176\u4E2D\u5305\u542B\u4E86\u7528\u6237\u4FE1\u606F\u5B9E\u4F53<code>UserEntity</code></p><p>\u7B2C\u4E00\u6B21\u767B\u5F55\u65F6, \u4F1A\u521B\u5EFA\u65B0\u7684token\u5E76\u4FDD\u5B58, \u6B63\u5E38\u8FD0\u884C</p><p>\u7B2C\u4E8C\u6B21\u767B\u9646\u65F6, \u6839\u636E\u4E0A\u4E00\u4E2A\u5751\u4E2D\u7684\u552F\u4E00ID, \u4ECE\u6570\u636E\u5E93\u8BFB\u53D6\u8BA4\u8BC1\u6388\u6743\u4FE1\u606F, <strong><code>UserEntity</code>\u5C06\u8FDB\u884C\u53CD\u5E8F\u5217\u5316</strong>, \u51FA\u73B0\u5982\u4E0B\u9519\u8BEF:</p><p><code>Could not read JSON: The class with cn.koala.system.entities.UserEntity and name of cn.koala.system.entities.UserEntity is not whitelisted. If you believe this class is safe to deserialize, please provide an explicit mapping using Jackson annotations or by providing a Mixin. If the serialization is only done by a trusted source, you can also enable default typing. See https://github.com/spring-projects/spring-security/issues/4370 for details</code></p><p>\u7F51\u4E0A\u6709\u5F88\u591A\u4FEE\u6539\u65B9\u5F0F, \u7B14\u8005\u63A8\u8350\u4F7F\u7528<strong>\u6CE8\u89E3<code>@JsonTypeInfo</code></strong>, \u7B80\u5355\u660E\u4E86:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonTypeInfo</span><span class="token punctuation">(</span>use <span class="token operator">=</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>Id</span><span class="token punctuation">.</span>CLASS<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>\u5982\u679C\u5C5E\u6027\u4E2D\u6709\u5D4C\u5957\u5BF9\u8C61, <strong>\u5D4C\u5957\u5BF9\u8C61\u4E5F\u9700\u8981\u589E\u52A0\u6CE8\u89E3</strong></p></div><h2 id="\u62D3\u5C55\u601D\u8003" tabindex="-1"><a class="header-anchor" href="#\u62D3\u5C55\u601D\u8003" aria-hidden="true">#</a> \u62D3\u5C55\u601D\u8003</h2><ul><li>\u5982\u4F55\u63D0\u4F9BSwagger\u652F\u6301?</li><li>\u5982\u4F55\u5B9E\u73B0\u52A8\u6001\u6743\u9650?</li></ul>`,30);function Z(Q,X){const a=i("ExternalLinkIcon");return o(),c("div",null,[k,d,v,m,h,n("p",null,[b,n("a",A,[g,t(a)])]),w,f,y,_,O,S,n("ul",null,[P,T,n("li",null,[C,n("a",E,[R,z,x,j,N,q,I,t(a)]),J]),M]),D,n("p",null,[G,n("a",H,[U,t(a)])]),B,n("div",W,[F,n("p",null,[L,n("a",V,[K,t(a)])])]),Y])}var nn=p(r,[["render",Z],["__file","index.html.vue"]]);export{nn as default};
